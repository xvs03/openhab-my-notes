# Rule Shelly Engery Counter non-volatile vie OpenHAB
#### Im OpenHAB Binding bietet Shelly einen Channel Namens Gesamtverbrauch an.

```JavaScript
// Zählerstand TOTAL über inkrementieren der Differenz zwischen den OH Updates des flüchtigen Shellyzählerstandes (Reset bei Stromunterbrechung)
// Triggerbedingung der Rule ist das Update des Shellyzählerstandes.

// Variablendefinition
var zW = 0; // Inkrementalwert durch Differenzberechnung der Zählerstände zwischen den Updates
var zInit_0 = 0; // Initialwert für NULL Wert im Item
var zTotToFloat = 0; // Totalzähler

// Aufrufen der Iteminhalte, generieren einer Variablen (ungeparst) und Logbucheintrag
// Rufe neuesten Stand vom Shelly ab (Triggerupdate) 
var zAkToFloat = items.getItem("PV2_Zaehlerstand_ab_Neustart").state;
console.log("Hole Wert aus Item  >>> Zählerstand shellyintern ab Neustart (flüchtig) [kWh]", zAkToFloat ); // Logbucheintrag

// Rufe alten vor dem Update Stand auf
var zAltToFloat = items.getItem("PV2_Zaehlerstand_vor_update").state;
console.log("Hole Wert aus Item  >>> Zählerstand TOTAL [kWh] vor Update", zAltToFloat ); // Logbucheintrag

// Rufe Totalzählerstand auf
var zTotToFloat = items.getItem("PV2_Zaehlerstand_total_Ab_Inbetriebnahme").state;
console.log("Hole Wert aus Item  >>> Zählerstand TOTAL [kWh] ab 29.7.24", zTotToFloat  ); // Logbucheintrag


   // Falls Item kein Format enthält mit 0 initialisieren
    // Item 1 Shellychannel !!!
    if (zAkToFloat == 'NULL' ){
      items.getItem("PV2_Zaehlerstand_ab_Neustart").postUpdate(zInit_0);
      console.log("Trage 0 als Wert in das Item Zählerstand shellyintern ab Neustart (flüchtig) [kWh]"); // Logbucheintrag
    }

    // Item 2 OH Cache (Hilfsitem)
    if (zAltToFloat == 'NULL' ){
      items.getItem("PV2_Zaehlerstand_vor_update").postUpdate(zInit_0);
      console.log("Trage 0 als Wert in das Item Zählerstand TOTAL [kWh] vor Update"); // Logbucheintrag
    }

    // Item 3 OH Totalzählerstand
    if (zTotToFloat == 'NULL' ){
      items.getItem("PV2_Zaehlerstand_total_Ab_Inbetriebnahme").postUpdate(zInit_0);
      console.log("Trage 0 als Wert in das Item Zählerstand TOTAL [kWh] ab 29.7.24"); // Logbucheintrag
    }


// Zählerstände parsen in Float
zAkToFloat = parseFloat(items.getItem("PV2_Zaehlerstand_ab_Neustart").state); // Aktueller Zählerstand
zAltToFloat = parseFloat(items.getItem("PV2_Zaehlerstand_vor_update").state); // Vorheriger Zählerstand
zTotToFloat = parseFloat(items.getItem("PV2_Zaehlerstand_total_Ab_Inbetriebnahme").state); // Total Zählerstand



// Für den Fall das der Shelly Zähler geflüchtet ist und auf 0 steht
  // Setze den Cachezählerstand auch auf 0. Sonst gibt es Minus Inkrementalwerte. Falls der neue Zählerstand aus dem Shelly kleiner ist als der alte im Cache z.B. nach Shelly Neustart
    if (zAkToFloat < zAltToFloat){
      items.getItem("PV2_Zaehlerstand_vor_update").postUpdate(zAkToFloat); // Item 2 OH Cache (Hilfsitem)
      console.log("Zählerreset am Shelly erkannt, synchronisiere Zählerstand mit Shelly >>> PV2_Zaehlerstand_ab_Neustart", zAkToFloat ); // Logbucheintrag
      
      // Rufe den geänderten Stand wieder auf
      zAltToFloat = items.getItem("PV2_Zaehlerstand_vor_update").state;
      console.log("Hole Wert aus Item  >>> Zählerstand TOTAL [kWh] vor Update neu synchronisiert", zAltToFloat ); // Logbucheintrag
    
      // Parse den Wert wieder
      zAltToFloat = parseFloat(items.getItem("PV2_Zaehlerstand_vor_update").state); // 0 gesetzten Zählerstand parsen und in Variable schreiben   
    } 


// Differenz der beiden Zählerstände ermitteln und das Ergebnis auf den TOTAL Zähler hinzu addieren
zW = zAkToFloat - zAltToFloat;
zTotToFloat = zTotToFloat + zW;
console.log("PV2 ermittelter Inkrementalwert", zW ); // Logbucheintrag
console.log("PV2 ermittelter neuer Totalzählerwert", zTotToFloat ); // Logbucheintrag

// Update TOTAL Zähler PV2 und Cachezähler
items.getItem("PV2_Zaehlerstand_total_Ab_Inbetriebnahme").postUpdate(zTotToFloat); // Update TOTAL Zähler
console.log("PV2 Totalzählerstand Update", zTotToFloat ); // Logbucheintrag
items.getItem("PV2_Zaehlerstand_vor_update").postUpdate(zAkToFloat); // Update Item 2 OH Cache (Hilfsitem) alt: zTotToFloat
console.log("PV2 Cachezähler update", zAkToFloat); // Logbucheintrag alt: zTotToFloat
```
